!function(e){e.fn.easytree=function(e){var r=this,n=new t(r,e);return n};var t=function(t,r){function n(t){var r=p(this),n=t.data,a=h(n,r);if(a&&(x(n),X.allowActivate&&(a.isActive=!0,e("#"+a.id).addClass("easytree-active"),X.stateChanged))){var i=A(n);X.stateChanged(n,i)}}function a(e){var t=p(this),r=e.data,n=h(r,t);n&&i(e,r,n)}function i(t,r,n){var a="";if(X.toggling&&(a=X.toggling(t,r,n),a===!1))return!1;if(n.isExpanded){if(X.closing&&(a=X.closing(t,r,n),a===!1))return!1}else if(X.opening&&(a=X.opening(t,r,n),a===!1))return!1;if(n.isLazy&&!n.isExpanded){var i=n.children&&n.children.length>0;if(a=!0,X.openLazyNode&&(a=X.openLazyNode(t,r,n,i)),n.lazyUrl&&a!==!1)return F(n.lazyUrl,n.lazyUrlJson,function(a){a.d&&(a=a.d);var i=k(a);e.isArray(i)?n.children=i:(n.children=[],n.children.push(i)),E(r),l(t,r,n)}),!1}l(t,r,n)}function l(e,t,r){if(r.isExpanded?(y(t,r.id,"close"),T(r,"close"),X.closed&&X.closed(e,t,r)):(y(t,r.id,"open"),T(r,"open"),X.opened&&X.opened(e,t,r)),X.toggled){X.toggled(e,t,r)}}function s(t){if(X.enableDnd){for(var r=t.target;r&&!(r.className.indexOf("easytree-draggable")>-1);)r=r.parentElement;if(r)return m(Y),x(Y),e("#"+r.id).addClass("easytree-drag-source"),f(V),V.createClone=!(r.className.indexOf("easytree-no-clone")>-1),V.dragok=!0,V.sourceEl=r,V.sourceId=r.id,V.sourceNode=h(Y,V.sourceId),!1}}function o(t){if(V.dragok&&X.enableDnd){V.createClone&&(V.clone||(V.clone=c(V.sourceEl),e(V.clone).appendTo("body")),V.clone.style.left=t.pageX+5+"px",V.clone.style.top=t.pageY+"px");var r=u(t.clientX,t.clientY);if(!r)return _(),V.targetEl=null,V.targetId=null,V.targetNode=null,void(V.canDrop=!1);if(r.id!=V.targetId){V.canDrop=!1,window.clearTimeout(V.openDelayTimeout),V.targetEl=r,V.targetId=r.id,V.targetNode=h(Y,V.targetId),M("source:"+(V.sourceNode&&V.sourceNode.text?V.sourceNode.text:V.sourceId)),M("target:"+(V.targetNode&&V.targetNode.text?V.targetNode.text:V.targetId)),M("isAncester:"+g(V.sourceNode,V.targetId));var n=e("#"+V.targetId);if(g(V.sourceNode,V.targetId))return void L();if(V.targetId==V.sourceId)return void _();if(X.canDrop){var a=null!=V.sourceNode,i=a?V.sourceNode:V.sourceEl,l=null!=V.targetNode,s=l?V.targetNode:V.targetEl,o=X.canDrop(t,Y,a,i,l,s);if(o===!0)return j(),V.canDrop=!0,void(V.openDelayTimeout=window.setTimeout(function(){y(Y,V.targetId,"open"),T(V.targetNode,"open")},600));if(o===!1)return void L()}return n.hasClass("easytree-reject")?L():n.hasClass("easytree-accept")?(j(),V.canDrop=!0,V.openDelayTimeout=window.setTimeout(function(){y(Y,V.targetId,"open"),T(V.targetNode,"open")},600)):_(),!1}}}function d(t){var r=null!=V.sourceNode,n=r?V.sourceNode:V.sourceEl,a=null!=V.targetNode,i=a?V.targetNode:V.targetEl,l=V.canDrop;if(_(),e("#_st_clone_").remove(),null===n||null===i)return f(V),!1;if(X.dropping){var s=X.dropping(t,Y,r,n,a,i,l);if(s===!1)return void f(V)}return V.targetNode&&V.sourceNode&&l&&(V.targetNode.children||(V.targetNode.children=[]),v(Y,V.sourceId),V.targetNode.children.push(V.sourceNode)),l&&(X.dropped&&X.dropped(t,Y,r,n,a,i),E(Y)),f(V),!1}function c(t){e(t).remove(".easytree-expander");var r=e(t).clone().remove(".easytree-expander").removeClass("easytree-drag-source")[0],n=r.children[0];return n&&"easytree-expander"==n.className&&r.removeChild(n),r.style.display="block",r.style.position="absolute",r.style.opacity=.5,r.id="_st_clone_",r.style.zIndex=1e3,r}function u(e,t){for(var r=document.elementFromPoint(e,t);r;){if(r.className.indexOf("easytree-droppable")>-1)return r;r=r.parentElement}return null}function f(e){e.canDrop=!1,e.createClone=!0,e.clone=null,e.dragok=!1,e.openDelayTimeout=null,e.targetEl=null,e.targetId=null,e.targetNode=null,e.sourceEl=null,e.sourceId=null,e.sourceNode=null}function p(e){for(;null!=e;){if(e.id)return e.id;e=e.parentElement}return null}function h(e,t){var r=0;for(r=0;r<e.length;r++){{var n=e[r];n.text}if(n.id==t)return n;var a=n.children&&n.children.length>0;if(a){var i=h(n.children,t);if(i)return i}}return null}function g(e,t){var r=0;if(!e||!e.children||0==e.children.length)return!1;for(r=0;r<e.children.length;r++){{var n=e.children[r];n.text}if(n.id==t)return!0;var a=n.children&&n.children.length>0;if(a){var i=g(n,t);if(i)return i}}return!1}function v(e,t){var r=0;for(r=0;r<e.length;r++){{var n=e[r];n.text}if(n.id==t)return void e.splice(r,1);var a=n.children&&n.children.length>0;a&&v(n.children,t)}}function y(e,t,r){var n=0;for(n=0;n<e.length;n++){{var a=e[n];a.text}if(a.id==t)return void(a.isExpanded="open"==r);var i=a.children&&a.children.length>0;i&&y(a.children,t,r)}}function x(t){var r=0;for(r=0;r<t.length;r++){var n=t[r];n.isActive=!1,e("#"+n.id).removeClass("easytree-active");var a=n.children&&n.children.length>0;a&&x(n.children)}}function m(t){var r=0;for(r=0;r<t.length;r++){var n=t[r];e("#"+n.id).removeClass("easytree-drag-source");var a=n.children&&n.children.length>0;a&&m(n.children)}}function N(e){var t=0;for(e=e.sort(function(e,t){var r=e.text.toLowerCase(),n=t.text.toLowerCase();r||(r="a"),n||(n="a"),X.ordering.toLowerCase().indexOf("folder")>-1&&e.isFolder&&(r="______"+r),X.ordering.toLowerCase().indexOf("folder")>-1&&t.isFolder&&(n="______"+n);var a=-1==X.ordering.indexOf(" DESC")?1:-1;return n>r?-1*a:r>n?1*a:0}),t=0;t<e.length;t++){var r=e[t],n=r.children&&r.children.length>0;n&&N(r.children)}return e}function C(e,t,r){var n=0;for(t||(t=0,r="_st_node_"+r+"_"),n=0;n<e.length;n++){var a=e[n];a.id||(a.id=r+n.toString());var i=a.children&&a.children.length>0;i&&C(a.children,t+1,r+n+"_")}}function E(t){if(t){{new Date}if(X.building){var r=X.building(t);if(r===!1)return!1}{new Date}X.ordering&&(t=N(t));var i=(new Date,Math.floor(1e4*Math.random()));C(t,0,i);{new Date}Y=t;{var l=b(t,0,!0);new Date}P[0].innerHTML=l;{new Date}e(P.selector+" .easytree-node").on("click",t,n),e(P.selector+" .easytree-expander").on("click",t,a),e(P.selector+" .easytree-icon").on("dblclick",t,a),e(P.selector+" .easytree-title").on("dblclick",t,a);{new Date}X.enableDnd&&(e(document).on("mousedown",s),e(document).on("mousemove",o),e(document).on("mouseup",d));{new Date}X.built&&X.built(t);{new Date}if(X.stateChanged){var c=A(t);X.stateChanged(t,c)}{new Date}}}function b(e,t,r){var n="",a=0,i="";0==t&&(i+="ui-easytree easytree-container easytree-focused");var l=t<X.minOpenLevels,s=0==t||r||l?"":" style='display:none' ";for(n+='<ul tabindex="0" class="'+i+'" '+s+'">',a=0;a<e.length;a++){var o=e[a];l===!0&&(o.isExpanded=!0);var d=a==e.length-1,c=I(o,d);n+="<li>",n+='<span id="'+o.id+'" class="'+c+' ">',n+=l?"":'<span class="easytree-expander"></span>',n+=w(o),n+=O(o),n+="</span>",o.children&&o.children.length>0&&(n+=b(o.children,t+1,o.isExpanded)),n+="</li>"}return n+="</ul>"}function I(e,t){var r=(e.children&&e.children.length>0,"easytree-node ");X.enableDnd&&(r+=" easytree-draggable "),e.liClass&&(r+=e.liClass),e.isFolder&&X.enableDnd?r+=" easytree-droppable easytree-accept ":X.enableDnd&&(r+=" easytree-droppable easytree-reject "),e.isActive&&X.allowActivate&&(r+=" easytree-active "),r+=D(e,t);var n=e.isExpanded?"e":"c";return e.isFolder&&(n+="f"),r+=" easytree-ico-"+n}function D(e,t){var r=e.children&&e.children.length>0,n="";return n=!r&&e.isLazy?"c":r?e.isExpanded?"e":"c":"n",t&&(n+="l")," easytree-exp-"+n}function w(e){var t="";return X.disableIcons?t:e.uiIcon?'<span class="easytree-custom-icon ui-icon '+e.uiIcon+'"></span>':e.iconUrl?'<span><img src="'+e.iconUrl+'" /></span>':'<span class="easytree-icon"></span>'}function O(e){var t="",r=e.tooltip?'title="'+e.tooltip+'"':"",n="easytree-title";return e.textCss&&(n+=" "+e.textCss),t+="<span "+r+' class="'+n+'">',e.href&&(t+='<a href="'+e.href+'" ',e.hrefTarget&&(t+=' target="'+e.hrefTarget+'" '),t+=">"),t+=e.text,e.href&&(t+="</a>"),t+="</span>"}function T(t,r){if(t){var n=e("#"+t.id).attr("class"),a=n.indexOf("easytree-exp-");if(a>-1){var i=n.indexOf(" ",a),l=i>-1?n.substring(a,i):n.substring(a);e("#"+t.id).removeClass(l),e("#"+t.id).addClass(D(t,!1))}var s=e("#"+t.id).parents("li").first(),o=s.children("ul").first(),d=parseInt(X.slidingTime,10);"close"==r?o.slideUp(d):o.slideDown(d)}}function _(){e("#easytree-reject").hide(),e("#easytree-accept").hide()}function j(){e("#easytree-accept").show(),e("#easytree-reject").hide()}function L(){e("#easytree-reject").show(),e("#easytree-accept").hide()}function A(e){for(var t=JSON.stringify?JSON.stringify(e):"Please import json2.js";t.indexOf(',"children":[]')>-1;)t=t.replace(',"children":[]',"");for(;t.indexOf('"liClass":"",')>-1;)t=t.replace('"liClass":"",',"");for(;t.indexOf('"textCss":"",')>-1;)t=t.replace('"textCss":"",',"");for(;t.indexOf('"isExpanded":false,')>-1;)t=t.replace('"isExpanded":false,',"");for(;t.indexOf('"isActive":false,')>-1;)t=t.replace('"isActive":false,',"");for(;t.indexOf('"isFolder":false,')>-1;)t=t.replace('"isFolder":false,',"");for(;t.indexOf('"isLazy":false,')>-1;)t=t.replace('"isLazy":false,',"");return t}function z(){U(),f(V),e(document).on("mousemove",function(e){var t=e.pageY,r=e.pageX;document.getElementById("easytree-reject").style.top=t+10+"px",document.getElementById("easytree-reject").style.left=r+17+"px",document.getElementById("easytree-accept").style.top=t+10+"px",document.getElementById("easytree-accept").style.left=r+17+"px"})}function U(){if(!e("#easytree-reject").length){var t='<div id="easytree-reject" class="easytree-drag-helper easytree-drop-reject">';t+='<span class="easytree-drag-helper-img"></span>',t+="</div>",e("body").append(t)}if(!e("#easytree-accept").length){var r='<div id="easytree-accept" class="easytree-drag-helper easytree-drop-accept">';r+='<span class="easytree-drag-helper-img"></span>',r+="</div>",e("body").append(r)}}function F(t,r,n){e.ajax({url:t,type:"POST",contentType:"application/json; charset=utf-8",data:r,success:n,error:function(e,t,r){alert("Error: "+e.responseText)}})}function k(t){var r=null;return"object"==typeof t?r=t:"string"==typeof t&&(t=e.trim(t),r=0==t.indexOf("[")||0==t.indexOf("{")?e.parseJSON(t):J(t)),r}function J(t){{var r=e(t),n=[];r.children().each(function(e){n.push(S(this))})}return n}function S(t){var r=e(t),n={},a=r.data();n.isActive=r.hasClass("isActive"),r.removeClass("isActive"),n.isFolder=r.hasClass("isFolder"),r.removeClass("isFolder"),n.isExpanded=r.hasClass("isExpanded"),r.removeClass("isExpanded"),n.isLazy=r.hasClass("isLazy"),r.removeClass("isLazy"),n.uiIcon=a.uiicon,n.liClass=r.attr("class"),n.id=r.attr("id");var i=r.children("a");i&&(n.href=i.attr("href"),n.hrefTarget=i.attr("target"));var l=r.children("img");l&&(n.iconUrl=l.attr("src")),n.textCss="";var s=r.children("span");s&&s.attr("class")&&(n.textCss+=s.attr("class")+" "),s=i.children("span"),s&&s.attr("class")&&(n.textCss+=s.attr("class")+" "),s=l.children("span"),s&&s.attr("class")&&(n.textCss+=s.attr("class")+" "),n.text=B(r[0]),n.tooltip=r.attr("title"),n.children=[];r.children("ul").children("li").each(function(e){n.children.push(S(this))});return n}function B(t){var r=0;for(r=0;r<t.childNodes.length;r++)for(var n=t.childNodes[r];n;){if(3==n.nodeType&&e.trim(n.nodeValue).length>0)return e.trim(n.nodeValue);n=n.firstChild}return""}function M(e){e||(e="null"),console.log(e)}var P,X={allowActivate:!0,data:null,dataUrl:null,dataUrlJson:null,disableIcons:!1,enableDnd:!1,ordering:null,slidingTime:100,minOpenLevels:0,building:null,built:null,toggling:null,toggled:null,opening:null,opened:null,openLazyNode:null,closing:null,closed:null,canDrop:null,dropping:null,dropped:null,stateChanged:null},Y=null,V=new Object;this.init=function(t,r){X=e.extend(X,r),z(),P=t;var n="";if(X.dataUrl)F(X.dataUrl,X.dataUrlJson,function(e){return(n=k(e))?(E(n),this):(alert("EasyTree: Invalid data!"),this)});else if(X.data){if(n=k(X.data),!n)return alert("EasyTree: Invalid data!"),this;E(n)}else{if(n=k(P.html()),!n)return alert("EasyTree: Invalid data!"),this;E(n)}return this},this.options=X,this.rebuildTree=function(e){var t=e?k(e):Y;t||alert("EasyTree: Invalid data!"),E(t)},this.getAllNodes=function(){return Y},this.getNode=function(e){return h(Y,e)},this.addNode=function(e,t){if(!t)return void Y.push(e);var r=h(Y,t);e&&(r.children||(r.children=[]),r.children.push(e))},this.removeNode=function(e){v(Y,e)},this.activateNode=function(t){if(x(Y),X.allowActivate){var r=h(Y,t);r&&(r.isActive=!0,e("#"+r.id).addClass("easytree-active"))}},this.toggleNode=function(e){var t=h(Y,e);t&&i(event,Y,t)},this.init(t,r)}}(jQuery);